<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple Social App (MD5 Version)</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
        #app-container { border: 1px solid #ccc; padding: 20px; }
        #login-form { display: block; }
        #main-app { display: none; }
        #messages-container { border: 1px solid #eee; padding: 10px; margin-top: 10px; }
        .message { border-bottom: 1px solid #eee; padding: 5px 0; }
        .dm { background-color: #f0f8ff; }
        .pfp { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .profile-pfp { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <h1>Simple Social App</h1>
            <p id="auth-status"></p>
        </header>

        <section id="login-form">
            <h2>Sign In</h2>
            <p style="color:red;">
              Warning: This version uses insecure MD5 hashing for demonstration purposes only.
            </p>
            <form id="sign-in-form">
                <input type="text" id="username" placeholder="Username" required><br>
                <input type="password" id="password" placeholder="Password" required><br>
                <button type="submit">Sign In</button>
            </form>
        </section>

        <section id="main-app">
            <nav>
                <button onclick="showPublicMessages()">Public Feed</button>
                <button onclick="showDMs()">My DMs</button>
                <button onclick="showProfile()">Profile</button>
                <button onclick="showSettings()">Settings</button>
                <button onclick="signOut()">Sign Out</button>
            </nav>

            <div id="feed">
                <h2>Public Feed</h2>
                <form id="public-message-form">
                    <input type="text" id="public-message-content" placeholder="What's on your mind?" required><br>
                    <button type="submit">Send Message</button>
                </form>
                <div id="public-messages-list"></div>
            </div>

            <div id="dms" style="display: none;">
                <h2>Direct Messages</h2>
                <form id="dm-form">
                    <input type="text" id="dm-recipient" placeholder="Recipient Username" required><br>
                    <input type="text" id="dm-content" placeholder="Your message" required><br>
                    <button type="submit">Send DM</button>
                </form>
                <div id="dms-list"></div>
            </div>
            
            <div id="profile-page" style="display: none;">
                <h2 id="profile-username"></h2>
                <img id="profile-pfp-img" class="profile-pfp" src="" alt="Profile Picture">
            </div>

            <div id="settings-page" style="display: none;">
                <h2>Settings</h2>
                <form id="settings-form">
                    <label for="pfp-link">Profile Picture URL:</label><br>
                    <input type="url" id="pfp-link" required><br>
                    <button type="submit">Update Profile Picture</button>
                </form>
            </div>
        </section>
    </div>

    <!-- Use a client-side MD5 library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // REPLACE WITH YOUR JSONBIN INFO
        const MASTER_KEY = 'YOUR_MASTER_KEY';
        const USERS_BIN_ID = 'YOUR_USERS_BIN_ID';
        const MESSAGES_BIN_ID = 'YOUR_MESSAGES_BIN_ID';
        const DMS_BIN_ID = 'YOUR_DMS_BIN_ID';

        const api = 'https://api.jsonbin.io/v3/b/';

        let currentUser = null;
        let userDataCache = null; // Cache user data after login

        // Utility to hide all content sections
        function hideAllSections() {
            document.getElementById('feed').style.display = 'none';
            document.getElementById('dms').style.display = 'none';
            document.getElementById('profile-page').style.display = 'none';
            document.getElementById('settings-page').style.display = 'none';
        }

        document.getElementById('sign-in-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const passwordHash = CryptoJS.MD5(password).toString();
            
            try {
                const response = await fetch(`${api}${USERS_BIN_ID}`, {
                    method: 'GET',
                    headers: {'X-Master-Key': MASTER_KEY}
                });
                userDataCache = await response.json();
                const user = userDataCache.record.users.find(u => u.username === username);

                if (user && user.passwordHash === passwordHash) {
                    currentUser = user.username;
                    document.getElementById('auth-status').textContent = `Logged in as ${currentUser}`;
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    showPublicMessages();
                } else {
                    alert('Invalid username or password.');
                }
            } catch (error) {
                console.error('Error during sign-in:', error);
                alert('An error occurred. Please try again.');
            }
        });

        document.getElementById('public-message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = document.getElementById('public-message-content').value;
            if (!currentUser || !content) return;

            const newMessage = {
                id: `msg_${Date.now()}`,
                author: currentUser,
                content: content,
                timestamp: new Date().toISOString()
            };

            await updateBin(MESSAGES_BIN_ID, 'messages', newMessage);
            document.getElementById('public-message-content').value = '';
            showPublicMessages();
        });

        document.getElementById('dm-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const recipient = document.getElementById('dm-recipient').value;
            const content = document.getElementById('dm-content').value;
            if (!currentUser || !recipient || !content) return;

            const newDM = {
                id: `dm_${Date.now()}`,
                sender: currentUser,
                recipient: recipient,
                content: content,
                timestamp: new Date().toISOString()
            };

            await updateBin(DMS_BIN_ID, 'dms', newDM, MASTER_KEY);
            document.getElementById('dm-recipient').value = '';
            document.getElementById('dm-content').value = '';
            showDMs();
        });

        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pfpLink = document.getElementById('pfp-link').value;
            
            if (!currentUser || !pfpLink) return;

            // Find the current user and update their pfp_url
            const users = userDataCache.record.users;
            const userIndex = users.findIndex(u => u.username === currentUser);
            if (userIndex !== -1) {
                users[userIndex].pfp_url = pfpLink;
            }

            // Update the entire users bin with the new data
            await updateBin(USERS_BIN_ID, 'users', users, MASTER_KEY, true);
            alert('Profile picture updated successfully!');
            showProfile(); // Redirect to profile page
        });

        async function updateBin(binId, key, newData, accessKey = null, replaceAll = false) {
            try {
                let updatedRecord;
                if (replaceAll) {
                    updatedRecord = { [key]: newData };
                } else {
                    const response = await fetch(`${api}${binId}`, {
                        method: 'GET',
                        headers: {'X-Master-Key': accessKey || MASTER_KEY}
                    });
                    if (!response.ok) throw new Error('Failed to retrieve bin data.');
                    const binData = await response.json();
                    updatedRecord = { ...binData.record, [key]: [...binData.record[key], newData] };
                }

                await fetch(`${api}${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': accessKey || MASTER_KEY
                    },
                    body: JSON.stringify(updatedRecord)
                });
            } catch (error) {
                console.error('Error updating bin:', error);
            }
        }

        async function showPublicMessages() {
            hideAllSections();
            document.getElementById('feed').style.display = 'block';
            const messagesList = document.getElementById('public-messages-list');
            messagesList.innerHTML = '';
            
            try {
                const response = await fetch(`${api}${MESSAGES_BIN_ID}/latest`);
                const data = await response.json();
                data.record.messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(msg => {
                    const el = document.createElement('div');
                    el.className = 'message';
                    const user = userDataCache.record.users.find(u => u.username === msg.author);
                    const pfpUrl = user ? user.pfp_url : 'https://i.pravatar.cc/300?u=default';
                    el.innerHTML = `
                        <img class="pfp" src="${pfpUrl}" alt="Profile Picture">
                        <strong>${msg.author}</strong> at ${new Date(msg.timestamp).toLocaleString()}: ${msg.content}
                    `;
                    messagesList.appendChild(el);
                });
            } catch (error) {
                console.error('Error fetching public messages:', error);
            }
        }

        async function showDMs() {
            hideAllSections();
            document.getElementById('dms').style.display = 'block';
            const dmsList = document.getElementById('dms-list');
            dmsList.innerHTML = '';

            try {
                const response = await fetch(`${api}${DMS_BIN_ID}`, {
                    method: 'GET',
                    headers: {'X-Master-Key': MASTER_KEY}
                });
                const data = await response.json();
                const myDMs = data.record.dms.filter(dm => dm.sender === currentUser || dm.recipient === currentUser);
                myDMs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(dm => {
                    const el = document.createElement('p');
                    el.className = 'message dm';
                    const label = dm.sender === currentUser ? `To ${dm.recipient}` : `From ${dm.sender}`;
                    el.textContent = `${label} at ${new Date(dm.timestamp).toLocaleString()}: ${dm.content}`;
                    dmsList.appendChild(el);
                });
            } catch (error) {
                console.error('Error fetching DMs:', error);
            }
        }

        function showProfile() {
            hideAllSections();
            document.getElementById('profile-page').style.display = 'block';
            const user = userDataCache.record.users.find(u => u.username === currentUser);
            if (user) {
                document.getElementById('profile-username').textContent = user.username;
                document.getElementById('profile-pfp-img').src = user.pfp_url || 'https://i.pravatar.cc/300?u=default';
            }
        }

        function showSettings() {
            hideAllSections();
            document.getElementById('settings-page').style.display = 'block';
            const user = userDataCache.record.users.find(u => u.username === currentUser);
            if (user) {
                document.getElementById('pfp-link').value = user.pfp_url || '';
            }
        }

        function signOut() {
            currentUser = null;
            userDataCache = null;
            document.getElementById('auth-status').textContent = '';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }
    </script>
</body>
</html>
